name: Test Podman Installer

on:
  push:
    paths:
      - "devsecops/install_podman.sh"
  pull_request:
    paths:
      - "devsecops/install_podman.sh"

jobs:
  test-basic:
    name: Basic Test
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Verify script exists
        run: |
          if [ ! -f "devsecops/install_podman.sh" ]; then
            echo "Error: install_podman.sh not found"
            exit 1
          fi
          chmod +x devsecops/install_podman.sh

      - name: Install basic dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y curl git

      - name: Run installer
        run: |
          cd devsecops
          ./install_podman.sh

  ubuntu-test:
    name: Ubuntu 22.04
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write

    steps:
      - uses: actions/checkout@v4

      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y curl git uidmap slirp4netns fuse-overlayfs

      - name: Configure rootless
        run: |
          echo "$USER:100000:65536" | sudo tee -a /etc/subuid
          echo "$USER:100000:65536" | sudo tee -a /etc/subgid
          mkdir -p ~/.config/containers
          mkdir -p ~/.local/share/containers/storage

      - name: Run Podman Installer
        run: |
          chmod +x devsecops/install_podman.sh
          yes | ./devsecops/install_podman.sh

      - name: Validate Podman rootless mode
        run: |
          if podman info | grep -q "rootless: true"; then
            echo "✅ Rootless mode confirmed"
          else
            echo "❌ Rootless mode NOT enabled"
            podman info || true
            exit 1
          fi

  debian-tests:
    name: Debian ${{ matrix.version }}
    runs-on: ubuntu-latest
    strategy:
      matrix:
        version: ["11", "12"]
      fail-fast: false

    container:
      image: debian:${{ matrix.version }}
      options: --privileged

    steps:
      - uses: actions/checkout@v4

      - name: Install dependencies
        run: |
          apt-get update
          apt-get install -y sudo curl git

      - name: Run Podman Installer
        run: |
          chmod +x devsecops/install_podman.sh
          ./devsecops/install_podman.sh

      - name: Validate Podman rootless mode
        run: |
          if podman info | grep -q "rootless: true"; then
            echo "✅ Rootless mode confirmed"
          else
            echo "❌ Rootless mode NOT enabled"
            podman info || true
            exit 1
          fi

  fedora-tests:
    name: Fedora ${{ matrix.version }}
    runs-on: ubuntu-latest
    strategy:
      matrix:
        version: ["38", "39"]
      fail-fast: false

    container:
      image: fedora:${{ matrix.version }}
      options: --privileged

    steps:
      - uses: actions/checkout@v4

      - name: Install dependencies
        run: |
          dnf update -y
          dnf install -y sudo curl git

      - name: Run Podman Installer
        run: |
          chmod +x devsecops/install_podman.sh
          ./devsecops/install_podman.sh

      - name: Validate Podman rootless mode
        run: |
          if podman info | grep -q "rootless: true"; then
            echo "✅ Rootless mode confirmed"
          else
            echo "❌ Rootless mode NOT enabled"
            podman info || true
            exit 1
          fi

  centos-tests:
    name: CentOS ${{ matrix.version }}
    runs-on: ubuntu-latest
    strategy:
      matrix:
        version: ["8", "9"]
      fail-fast: false

    container:
      image: quay.io/centos/centos:stream${{ matrix.version }}
      options: --privileged

    steps:
      - uses: actions/checkout@v4

      - name: Install dependencies
        run: |
          yum update -y
          yum install -y sudo curl git

      - name: Run Podman Installer
        run: |
          chmod +x devsecops/install_podman.sh
          ./devsecops/install_podman.sh

      - name: Validate Podman rootless mode
        run: |
          if podman info | grep -q "rootless: true"; then
            echo "✅ Rootless mode confirmed"
          else
            echo "❌ Rootless mode NOT enabled"
            podman info || true
            exit 1
          fi

  macos-test:
    name: macOS
    runs-on: macos-latest
    timeout-minutes: 30

    steps:
      - uses: actions/checkout@v4

      - name: Run Podman Installer
        run: |
          chmod +x devsecops/install_podman.sh
          ./devsecops/install_podman.sh

      - name: Validate Podman rootless mode
        run: |
          if podman info | grep -q "rootless: true"; then
            echo "✅ Rootless mode confirmed"
          else
            echo "❌ Rootless mode NOT enabled"
            podman info || true
            exit 1
          fi

  windows-test:
    name: Windows (Git Bash)
    runs-on: windows-latest
    shell: bash

    steps:
      - uses: actions/checkout@v4

      - name: Run Podman Installer
        run: |
          chmod +x devsecops/install_podman.sh
          ./devsecops/install_podman.sh

      - name: Validate Podman rootless mode
        run: |
          if podman info | grep -q "rootless: true"; then
            echo "✅ Rootless mode confirmed"
          else
            echo "❌ Rootless mode NOT enabled"
            podman info || true
            exit 1
          fi
